<!DOCTYPE html>
<html>
<head>
    <title>ACF Keeping Active — Scores</title>
    <link rel="stylesheet" href="style.css">

    <script>
        let sessionData = JSON.parse(localStorage.getItem("current_session")) || null;
        let previousTotals = JSON.parse(localStorage.getItem("previousTotals")) || {};
        let previousBests = JSON.parse(localStorage.getItem("previousBests")) || {};
        let sessionHistory = JSON.parse(localStorage.getItem("sessionHistory")) || [];

        if (!sessionData || !sessionData.attending) {
            alert("No attendance data found.");
            window.location.href = "attendance.html";
        }

        function loadScoreTable() {
            const table = document.getElementById("scoreTable");

            table.innerHTML = `
                <tr>
                    <th>Surname</th>
                    <th>First Name</th>
                    <th>Score (0–10)</th>
                </tr>
            `;

            sessionData.attending.forEach(cadet => {
                table.insertAdjacentHTML("beforeend", `
                    <tr>
                        <td>${cadet.surname}</td>
                        <td>${cadet.firstname}</td>
                        <td>
                            <input type="number" min="0" max="10" value="0" id="score_${cadet.id}">
                        </td>
                    </tr>
                `);
            });
        }

        function saveScores() {
            let results = [];

            sessionData.attending.forEach(cadet => {
                const score = Number(document.getElementById(`score_${cadet.id}`).value) || 0;

                if (!previousTotals[cadet.id]) previousTotals[cadet.id] = 0;
                previousTotals[cadet.id] += score;

                if (!previousBests[cadet.id] || score > previousBests[cadet.id]) {
                    previousBests[cadet.id] = score;
                }

                results.push({
                    id: cadet.id,
                    firstname: cadet.firstname,
                    surname: cadet.surname,
                    score
                });
            });

            sessionHistory.push({
                date: sessionData.timestamp,
                det: sessionData.det,
                results
            });

            localStorage.setItem("previousTotals", JSON.stringify(previousTotals));
            localStorage.setItem("previousBests", JSON.stringify(previousBests));
            localStorage.setItem("sessionHistory", JSON.stringify(sessionHistory));

            window.location.href = "completion.html";
        }

        window.onload = loadScoreTable;
    </script>
</head>

<body>

<div class="ka-header">ACF Keeping Active — Scores</div>

<h2 class="page-title">Enter Scores</h2>

<table id="scoreTable"></table>

<button class="btn btn-primary" onclick="saveScores()">Save Scores →</button>

</body>
</html>